<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosaic Pro - Create Video Memories</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- MP4 Muxer (The Engine) -->
    <script src="https://cdn.jsdelivr.net/npm/mp4-muxer@5.1.0/build/mp4-muxer.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        #debug-console { font-family: 'Courier New', Courier, monospace; font-size: 11px; line-height: 1.4; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .gradient-text {
            background: linear-gradient(to right, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Hide browser default number input arrows */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
}
input[type=number] {
    -moz-appearance: textfield; /* Firefox */
}
    </style>
</head>
<body class="bg-gray-950 text-white font-sans min-h-screen selection:bg-blue-500 selection:text-white">

    <!-- ========================================== -->
    <!-- SECTION 1: LANDING PAGE (Visible by default) -->
    <!-- ========================================== -->
    <div id="landing-view" class="fade-in">
        
        <!-- Navbar -->
        <nav class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="grid-3x3" class="text-blue-500 w-8 h-8"></i>
                <span class="text-xl font-bold tracking-tight">Mosaic<span class="text-blue-500">Pro</span></span>
            </div>
            <div class="flex items-center space-x-6">
                <a href="https://github.com/aoslm/" class="text-gray-400 hover:text-white text-sm font-medium transition hidden md:block">GitHub</a>
                <a href="https://buymeacoffee.com/aoslm" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-full text-sm font-bold border border-gray-700 transition flex items-center">
                    <i data-lucide="coffee" class="w-4 h-4 mr-2 text-yellow-500"></i> Donate
                </a>
            </div>
        </nav>

        <!-- Hero Section -->
        <header class="max-w-5xl mx-auto text-center mt-16 px-4 mb-24">
            <div class="inline-block px-4 py-1.5 rounded-full bg-blue-900/30 border border-blue-800 text-blue-300 text-xs font-bold tracking-widest uppercase mb-6">
                100% Client-Side • Hardware Accelerated • Free to use
            </div>
            <h1 class="text-5xl md:text-7xl font-extrabold leading-tight mb-6">
                Turn Party Chaos into <br />
                <span class="gradient-text">Beautiful Mosaic Memories</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-400 max-w-2xl mx-auto mb-10 leading-relaxed">
                Stitch your selfie videos into a mesmerizing, synchronized grid. 
                Runs entirely in your browser using your GPU. No server uploads, total privacy.
            </p>
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                <button onclick="enterApp()" class="px-8 py-4 rounded-full bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg shadow-[0_0_20px_rgba(37,99,235,0.5)] transition hover:scale-105 flex items-center">
                    Start Creating <i data-lucide="arrow-right" class="ml-2 w-5 h-5"></i>
                </button>
                <!-- <a href="#how-it-works" class="px-8 py-4 rounded-full bg-gray-900 hover:bg-gray-800 text-gray-300 font-bold text-lg border border-gray-800 transition"> -->
                    <!-- See Examples -->
                <!-- </a> -->
            </div>
        </header>

        <!-- Feature Grid -->
        <section id="how-it-works" class="bg-gray-900 py-24 border-y border-gray-800">
            <div class="max-w-7xl mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="text-3xl font-bold mb-4">Everything needed, super simple</h2>
                    <p class="text-gray-400">Professional editing logic, simplified into one button.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- F1 -->
                    <div class="p-8 rounded-3xl bg-gray-950 border border-gray-800 hover:border-blue-500/50 transition duration-300">
                        <div class="w-12 h-12 bg-blue-900/20 rounded-xl flex items-center justify-center mb-6">
                            <i data-lucide="shield-check" class="text-blue-400 w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">100% Private</h3>
                        <p class="text-gray-400 leading-relaxed">Your videos never leave your device. All processing happens locally in your browser using WebCodecs.</p>
                    </div>

                    <!-- F2 -->
                    <div class="p-8 rounded-3xl bg-gray-950 border border-gray-800 hover:border-purple-500/50 transition duration-300">
                        <div class="w-12 h-12 bg-purple-900/20 rounded-xl flex items-center justify-center mb-6">
                            <i data-lucide="zap" class="text-purple-400 w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">GPU Accelerated</h3>
                        <p class="text-gray-400 leading-relaxed">We use your computer's hardware to render HD (1080p) videos in seconds, not minutes.</p>
                    </div>

                    <!-- F3 -->
                    <div class="p-8 rounded-3xl bg-gray-950 border border-gray-800 hover:border-green-500/50 transition duration-300">
                        <div class="w-12 h-12 bg-green-900/20 rounded-xl flex items-center justify-center mb-6">
                            <i data-lucide="layers" class="text-green-400 w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">Auto-Loop Sync</h3>
                        <p class="text-gray-400 leading-relaxed">Short clips? Long clips? We automatically loop and synchronize them to fit your perfect grid.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testimonials -->
        <section class="py-24 max-w-7xl mx-auto px-6">
            <h2 class="text-3xl font-bold text-center mb-16">Loved by Creators</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- T1 -->
                <div class="bg-gray-800/50 p-6 rounded-2xl border border-gray-700">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-orange-400 rounded-full"></div>
                        <div class="ml-3">
                            <p class="font-bold text-sm">Sarah Jenkins</p>
                            <p class="text-xs text-gray-500">Event Planner</p>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm">"Used this for a wedding recap reel. The 4x4 grid looked absolutely stunning on Instagram Stories. Saved me hours in After Effects."</p>
                </div>
                <!-- T2 -->
                <div class="bg-gray-800/50 p-6 rounded-2xl border border-gray-700">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-full"></div>
                        <div class="ml-3">
                            <p class="font-bold text-sm">Davide M.</p>
                            <p class="text-xs text-gray-500">TikTok Creator</p>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm">"The fact that it runs in browser is crazy. No watermark and instant download? Take my money."</p>
                </div>
                <!-- T3 -->
                <div class="bg-gray-800/50 p-6 rounded-2xl border border-gray-700">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-400 rounded-full"></div>
                        <div class="ml-3">
                            <p class="font-bold text-sm">Alex Chen</p>
                            <p class="text-xs text-gray-500">Developer</p>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm">"Inspected the code. It actually uses WebCodecs API properly. Very clean implementation. 10/10."</p>
                </div>
            </div>
        </section>

        <!-- CTA / Footer -->
        <footer class="bg-black py-12 border-t border-gray-800 text-center">
            <div class="max-w-2xl mx-auto px-4">
                <i data-lucide="coffee" class="w-8 h-8 text-yellow-500 mx-auto mb-4"></i>
                <h3 class="text-2xl font-bold mb-4">Free & Open Source</h3>
                <p class="text-gray-400 mb-8">
                    I built this because I did not find tool for simple video grids.
                    <br>If it helped you, consider buying me a coffee!
                </p>
                
                <div class="flex justify-center gap-4">
                    <!-- REPLACE WITH YOUR BUY ME A COFFEE LINK -->
                    <a href="https://buymeacoffee.com/aoslm" target="_blank" class="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-3 rounded-xl font-bold transition flex items-center">
                        Buy me a Coffee
                    </a>
                    <!-- REPLACE WITH YOUR GITHUB LINK -->
                    <a href="https://github.com/aoslm/" target="_blank" class="bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-bold transition flex items-center">
                        <i data-lucide="github" class="w-4 h-4 mr-2"></i> Star on GitHub
                    </a>
                </div>
                <p class="text-xs text-gray-600 mt-12">&copy; 2025 Mosaic Pro. All rights reserved.</p>
            </div>
        </footer>
    </div>


    <!-- ========================================== -->
    <!-- SECTION 2: THE TOOL (Hidden by default)    -->
    <!-- ========================================== -->
    <div id="app-view" class="hidden min-h-screen bg-gray-900 p-4 md:p-8">
        <!-- Back Button -->
        <div class="max-w-7xl mx-auto mb-6">
            <button onclick="exitApp()" class="text-gray-400 hover:text-white flex items-center transition">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Home
            </button>
        </div>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            
            <!-- CONTROLS -->
            <div class="space-y-6">
                <header>
                    <h1 class="text-3xl font-extrabold text-blue-400 flex items-center">
                        Mosaic Pro 
                        <span class="ml-3 px-2 py-1 bg-purple-900 text-purple-200 text-[10px] rounded border border-purple-700 uppercase tracking-widest">Safe Video Processing in Browser </span>
                    </h1>
                </header>
    
                <!-- DEBUG LOG CONSOLE -->
                <div class="bg-black border border-gray-700 rounded-lg overflow-hidden shadow-lg flex flex-col h-48">
                    <div class="bg-gray-800 px-4 py-2 text-xs font-bold text-gray-400 border-b border-gray-700 flex justify-between">
                        <span>SYSTEM LOG</span>
                        <span id="system-status" class="text-yellow-500">Initializing...</span>
                    </div>
                    <div id="debug-console" class="flex-1 overflow-y-auto p-4 text-green-400 bg-black/90"></div>
                </div>
    
                <!-- UPLOAD BOX -->
                <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 space-y-4">
                    <label for="video-input" id="drop-zone" class="group flex flex-col items-center justify-center w-full h-24 border-2 border-gray-600 border-dashed rounded-xl cursor-pointer hover:bg-gray-700 hover:border-blue-500 transition-all relative">
                        <div class="text-center z-10">
                            <i data-lucide="upload-cloud" class="w-6 h-6 text-gray-400 mb-2 mx-auto"></i>
                            <p class="text-xs text-gray-300 font-bold">Click to Upload</p>
                        </div>
                        <input id="video-input" type="file" class="sr-only" multiple accept="video/*" />
                    </label>

                <!-- REIMAGINED SETTINGS SECTION -->
<div class="bg-gray-950/50 p-4 rounded-xl border border-gray-800 space-y-4">
    
    <!-- Row 1: Grid Configuration -->
    <div>
        <label class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2 block">Grid Layout</label>
        <div class="grid grid-cols-2 gap-4">
            
            <!-- Rows Input -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="align-justify" class="h-4 w-4 text-gray-500 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input id="rows-input" type="number" value="4" min="1" max="10" 
                    class="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block pl-10 p-2.5 transition-all outline-none" 
                    placeholder="Rows">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-600 text-xs">Rows</span>
                </div>
            </div>

            <!-- Cols Input -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="columns" class="h-4 w-4 text-gray-500 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input id="cols-input" type="number" value="4" min="1" max="10" 
                    class="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block pl-10 p-2.5 transition-all outline-none" 
                    placeholder="Cols">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-600 text-xs">Cols</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Video Settings -->
    <div>
        <label class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2 block">Output Settings</label>
        <div class="grid grid-cols-2 gap-4">
            
            <!-- Duration Input -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="clock" class="h-4 w-4 text-gray-500 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input id="duration-input" type="number" value="5" min="1" max="60" 
                    class="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block pl-10 p-2.5 transition-all outline-none" 
                    placeholder="Sec">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-600 text-xs">Sec</span>
                </div>
            </div>

            <!-- FPS Custom Select Box -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="film" class="h-4 w-4 text-gray-500 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <select id="fps-input" 
                    class="appearance-none w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block pl-10 pr-10 p-2.5 transition-all outline-none cursor-pointer">
                    <option value="24">24 FPS (Film)</option>
                    <option value="30" selected>30 FPS (Standard)</option>
                    <option value="60">60 FPS (Smooth)</option>
                </select>
                <!-- Custom Chevron Icon -->
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400 group-hover:text-white transition-colors">
                    <i data-lucide="chevron-down" class="h-4 w-4"></i>
                </div>
            </div>

        </div>
    </div>
</div>   <button id="generate-btn" disabled class="w-full py-3 rounded-xl font-bold text-lg bg-gray-700 text-gray-400 cursor-not-allowed transition flex items-center justify-center">
                    Check Console
                </button>
                
                <!-- PROGRESS -->
                <div id="progress-container" class="hidden">
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full w-0 transition-all duration-75"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span id="status-text">Idle</span>
                        <span id="percent-text">0%</span>
                    </div>
                </div>
            </div>
    
            <!-- RIGHT: PREVIEW -->
            <div class="bg-black rounded-3xl border border-gray-800 shadow-2xl flex flex-col items-center justify-center min-h-[500px] relative overflow-hidden">
                <canvas id="mosaic-canvas" class="hidden"></canvas>
                
                <div id="placeholder-ui" class="text-center p-8">
                    <i data-lucide="monitor-play" class="w-12 h-12 text-gray-700 mx-auto mb-4"></i>
                    <p class="text-gray-500 text-sm">MP4 Preview Area</p>
                </div>
    
                <video id="final-video" controls playsinline loop class="hidden w-full h-full object-contain bg-black z-10"></video>
                
                <a id="download-btn" class="hidden absolute bottom-6 bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-full font-bold shadow-lg z-20 cursor-pointer">
                    Download MP4
                </a>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT (Logic Intact + View Switching) -->
    <script>
        // --- Navigation Logic ---
        function enterApp() {
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('fade-in');
            window.scrollTo(0, 0);
        }

        function exitApp() {
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('landing-view').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // --- 1. Logger ---
        const consoleDiv = document.getElementById('debug-console');
        function log(msg, type = "info") {
            const time = new Date().toLocaleTimeString().split(' ')[0];
            const line = document.createElement('div');
            line.innerHTML = `<span class="opacity-50 select-none">[${time}]</span> ${msg}`;
            if (type === 'error') line.className = "text-red-500 font-bold bg-red-900/20";
            if (type === 'success') line.className = "text-green-400 font-semibold";
            if (type === 'warn') line.className = "text-yellow-400";
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            log("System Boot...");
            if (typeof lucide !== 'undefined') lucide.createIcons();
            if (typeof VideoEncoder === 'undefined') {
                log("CRITICAL ERROR: Browser does not support WebCodecs.", "error");
                return;
            }
            if (typeof Mp4Muxer === 'undefined') {
                log("CRITICAL ERROR: Mp4Muxer missing.", "error");
                return;
            }
            log("HD Codec Engine Ready.", "success");
            const btn = document.getElementById('generate-btn');
            btn.disabled = false;
            btn.className = "w-full py-3 rounded-xl font-bold text-lg bg-blue-600 hover:bg-blue-500 text-white shadow-lg transition cursor-pointer";
            btn.innerText = "Generate MP4";
            document.getElementById('system-status').innerText = "System Ready";
            document.getElementById('system-status').className = "text-green-500";
        });

        // --- 3. DOM Elements ---
        const els = {
            input: document.getElementById('video-input'),
            dropZone: document.getElementById('drop-zone'),
            btn: document.getElementById('generate-btn'),
            progress: document.getElementById('progress-container'),
            bar: document.getElementById('progress-bar'),
            status: document.getElementById('status-text'),
            pct: document.getElementById('percent-text'),
            canvas: document.getElementById('mosaic-canvas'),
            video: document.getElementById('final-video'),
            download: document.getElementById('download-btn'),
            placeholder: document.getElementById('placeholder-ui'),
            rows: document.getElementById('rows-input'),
            cols: document.getElementById('cols-input'),
            dur: document.getElementById('duration-input'),
            fps: document.getElementById('fps-input')
        };

        let uploadedFiles = [];
        let stopProcess = false;

        // --- 4. File Handling ---
        els.input.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            uploadedFiles.forEach(u => URL.revokeObjectURL(u));
            uploadedFiles = files.map(f => URL.createObjectURL(f));
            log(`Loaded ${files.length} videos.`);
            els.dropZone.classList.add('border-green-500', 'bg-gray-800');
        });

        // --- 5. Seek Helper ---
        const seekTo = (vid, time) => {
            return new Promise(resolve => {
                if (Math.abs(vid.currentTime - time) < 0.05) return resolve();
                vid.currentTime = time;
                const handler = () => {
                    vid.removeEventListener('seeked', handler);
                    resolve();
                };
                vid.addEventListener('seeked', handler, { once: true });
                setTimeout(resolve, 800); 
            });
        };

        // --- 6. Main Encoder Logic (Intact) ---
        els.btn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) return alert("Upload videos first");
            runEncodingProcess(false);
        });

        async function runEncodingProcess(forceLowQuality) {
            stopProcess = false;
            els.btn.disabled = true;
            els.btn.innerText = forceLowQuality ? "Retrying (Safe Mode)..." : "Initializing...";
            els.progress.classList.remove('hidden');
            els.placeholder.classList.add('hidden');
            els.video.classList.add('hidden');
            els.download.classList.add('hidden');

            const targetWidth = forceLowQuality ? 720 : 1080;
            const targetHeight = forceLowQuality ? 1280 : 1920;
            const targetLevel = forceLowQuality ? 'avc1.4d001f' : 'avc1.4d0033'; 

            try {
                const rows = parseInt(els.rows.value) || 4;
                const cols = parseInt(els.cols.value) || 4;
                const durationSec = parseInt(els.dur.value) || 5;
                const fps = parseInt(els.fps.value) || 30;
                
                els.canvas.width = targetWidth;
                els.canvas.height = targetHeight;
                const ctx = els.canvas.getContext('2d');
                const cellW = targetWidth / cols;
                const cellH = targetHeight / rows;

                log(`Config: ${targetWidth}x${targetHeight} @ ${fps}fps (${forceLowQuality ? 'Safe' : 'High Quality'})`);

                const muxer = new Mp4Muxer.Muxer({
                    target: new Mp4Muxer.ArrayBufferTarget(),
                    video: { codec: 'avc', width: targetWidth, height: targetHeight },
                    fastStart: 'in-memory'
                });

                const videoEncoder = new VideoEncoder({
                    output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
                    error: (e) => {
                        stopProcess = true;
                        log("Encoder Error: " + e.message, "error");
                        if (!forceLowQuality) {
                            log("High Quality failed. Switching to Safe Mode (720p)...", "warn");
                            setTimeout(() => runEncodingProcess(true), 1000);
                        }
                    }
                });

                const codecConfig = {
                    codec: targetLevel, 
                    width: targetWidth,
                    height: targetHeight,
                    bitrate: forceLowQuality ? 2_500_000 : 6_000_000,
                    framerate: fps
                };

                try {
                    videoEncoder.configure(codecConfig);
                    log("Encoder configured.");
                } catch (configErr) {
                    if (!forceLowQuality) {
                        log("Level 5.1 rejected. Retrying Safe Mode...", "warn");
                        return runEncodingProcess(true);
                    } else throw configErr;
                }

                log("Buffering videos...");
                const videos = [];
                for(let i=0; i < rows*cols; i++) {
                    const v = document.createElement('video');
                    v.src = uploadedFiles[i % uploadedFiles.length];
                    v.muted = true;
                    v.playsInline = true;
                    v.crossOrigin = "anonymous";
                    await new Promise(r => { v.onloadedmetadata = r; v.onerror = r; });
                    videos.push(v);
                }

                const totalFrames = durationSec * fps;
                log(`Starting Loop (${totalFrames} frames)`);

                for(let f=0; f < totalFrames; f++) {
                    if (stopProcess) return;
                    const time = f / fps;
                    
                    if(f % 5 === 0) {
                        const pct = Math.round((f/totalFrames)*100);
                        els.bar.style.width = `${pct}%`;
                        els.pct.innerText = `${pct}%`;
                        els.status.innerText = `Frame ${f}/${totalFrames}`;
                        await new Promise(r => setTimeout(r, 0));
                    }

                    await Promise.all(videos.map(v => seekTo(v, time % v.duration)));

                    ctx.fillStyle = "#000";
                    ctx.fillRect(0, 0, targetWidth, targetHeight);
                    
                    videos.forEach((v, idx) => {
                        const r = Math.floor(idx / cols);
                        const c = idx % cols;
                        const x = c * cellW;
                        const y = r * cellH;
                        const ratio = Math.max(cellW / v.videoWidth, cellH / v.videoHeight);
                        const sx = (cellW - v.videoWidth * ratio) / 2;
                        const sy = (cellH - v.videoHeight * ratio) / 2;

                        ctx.save();
                        ctx.beginPath();
                        ctx.rect(x, y, cellW, cellH);
                        ctx.clip();
                        ctx.drawImage(v, 0, 0, v.videoWidth, v.videoHeight, x + sx, y + sy, v.videoWidth * ratio, v.videoHeight * ratio);
                        ctx.restore();
                    });

                    const frame = new VideoFrame(els.canvas, { timestamp: (f * 1000000) / fps });
                    videoEncoder.encode(frame, { keyFrame: f % (fps * 2) === 0 });
                    frame.close();
                }

                if (stopProcess) return;

                log("Flushing encoder...");
                await videoEncoder.flush();
                muxer.finalize();

                const { buffer } = muxer.target;
                const blob = new Blob([buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);

                log(`Success! MP4 Generated.`, "success");

                els.video.src = url;
                els.video.classList.remove('hidden');
                els.download.href = url;
                els.download.download = `mosaic_${forceLowQuality ? '720p' : '1080p'}_${Date.now()}.mp4`;
                els.download.classList.remove('hidden');
                els.btn.disabled = false;
                els.btn.innerText = "Generate MP4";

            } catch (err) {
                if (!forceLowQuality && !stopProcess) {
                    log("Unexpected error. Retrying Safe Mode...", "warn");
                    return runEncodingProcess(true);
                }
                stopProcess = true;
                log("Stopped: " + err.message, "error");
                els.btn.disabled = false;
            }
        }
    </script>
</body>
</html>
